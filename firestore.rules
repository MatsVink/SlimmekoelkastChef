/**
 * This ruleset enforces a strict append-only security model for the application's recipe history.
 *
 * Core Philosophy:
 * The primary security goal is to allow any authenticated user, including those signed in anonymously,
 * to save their recipe generation history without being able to view or modify any other history
 * entries, including their own. This creates a "write-only" or "append-only" log.
 *
 * Data Structure:
 * All data is stored in a single, top-level collection named `recipe_history`. There are no
 * user-specific subcollections, as the application supports anonymous users and the data schema
 * does not contain user ownership information.
 *
 * Key Security Decisions:
 * - Append-Only Access: Users can only `create` new documents in the `recipe_history` collection.
 * - No Reads or Modifications: All `get`, `list`, `update`, and `delete` operations are explicitly
 *   denied. This is the most secure posture, preventing any possibility of one user viewing another's
 *   data and protecting the integrity of the history log.
 * - Anonymous Users are Authenticated: The rules treat anonymous users as "signed in," allowing
 *   them to contribute to the history log.
 *
 * Denormalization for Authorization:
 * This principle is not applicable here, as the chosen security model (append-only) does not require
 * relational data for its authorization checks. If user-specific access were required in the future,
 * the `recipe_history` documents would need to be denormalized with a `userId` field.
 *
 * Structural Segregation:
 * This principle is not applicable, as all data in the `recipe_history` collection shares the same
 * security profile (private, append-only).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions

    /**
     * Checks if the user is authenticated, including anonymous users.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description
     *   Rules for the `recipe_history` collection, which acts as an append-only log.
     *   Any signed-in user (including anonymous users) can create a new history
     *   entry, but no one can read, update, or delete any entries.
     * @path
     *   /recipe_history/{recipeHistoryId}
     * @allow
     *   (create) An anonymous or signed-in user creates a new recipe history document.
     * @deny
     *   (get) Any user, signed-in or not, tries to read a recipe history document.
     * @deny
     *   (update) Any user tries to modify an existing recipe history document.
     * @principle
     *   Implements a secure append-only log. This is the most secure approach
     *   for a collection where documents lack an explicit ownership field, as it
     *   prevents data leakage and modification.
     */
    match /recipe_history/{recipeHistoryId} {
      // READ operations are completely disallowed to prevent any user from seeing another's history.
      allow get: if false;
      allow list: if false;

      // WRITE operations are restricted to creating new documents.
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}